automation:
  - id: tesla_solar_charging_start
    alias: Tesla Solar Charging Start
    trigger:
    - platform: numeric_state
      entity_id: sensor.energy_meter_total_watts
      below: '-1500'
      for: 00:05:00
    - platform: time
      at: 09:05:00
    condition:
    - condition: state
      entity_id: binary_sensor.tesla_wall_connector_vehicle_connected
      state: 'on'
    - condition: state
      entity_id: input_boolean.charging_override
      state: 'off'
    - condition: numeric_state
      entity_id: sensor.lucy_battery
      below: input_number.tesla_max_battery
    - condition: time
      after: 09:00:00
      before: '15:00:00'
    action:
    - condition: state
      entity_id: binary_sensor.tesla_wall_connector_contactor_closed
      state: 'off'
    - service: switch.turn_on
      data:
        entity_id:
        - switch.lucy_charger_switch

  - id: tesla_charging_stop
    alias: Tesla Charging Stop
    trigger:
    - platform: numeric_state
      entity_id: sensor.energy_meter_total_watts
      above: '500'
      for: 00:05:00
    - platform: time
      at: '14:59'
    - platform: state
      entity_id: binary_sensor.tesla_wall_connector_contactor_closed
      to: 'on'
    condition:
      or:
        - condition: time
          before: 09:00:00
          after: '14:58:00'
        - condition: numeric_state
          entity_id: sensor.energy_meter_total_watts
          above: '500'
    action:
    - condition: state
      entity_id: binary_sensor.tesla_wall_connector_contactor_closed
      state: 'on'
    - condition: state
      entity_id: input_boolean.charging_override
      state: 'off'
    - service: switch.turn_off
      data:
        entity_id:
        - switch.lucy_charger_switch

  - id: tesla_solar_charging_set
    alias: Tesla Solar Charging Set
    trigger:
    - platform: state
      entity_id: input_number.tesla_charging_amps
    - platform: state
      entity_id: binary_sensor.tesla_wall_connector_contactor_closed
      to: 'on'
      for: 00:01:00
    condition:
    - condition: state
      entity_id: binary_sensor.tesla_wall_connector_contactor_closed
      state: 'on'
    - condition: state
      entity_id: input_boolean.charging_override
      state: 'off'
    action:
    - service: tesla_custom.api
      data:
        command: CHARGING_AMPS
        parameters:
          path_vars:
            vehicle_id: "{{ state_attr('binary_sensor.lucy_online_sensor', 'id') }}"
          charging_amps: "{{ (states('input_number.tesla_charging_amps')|int) }}"